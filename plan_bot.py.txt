import telebot
import threading
from datetime import datetime, timedelta
import time
import json
import os

# ğŸ”‘ BOT TOKENÄ°NÄ° BURADA DÆYÄ°Å
bot = telebot.TeleBot("YOUR_BOT_TOKEN")

DATA_FILE = "plans.json"

# ğŸ“ Fayldan planlarÄ± yÃ¼klÉ™
def load_plans():
    if os.path.exists(DATA_FILE):
        with open(DATA_FILE, "r", encoding="utf-8") as f:
            data = json.load(f)
        # datetime obyektlÉ™rinÉ™ Ã§evir
        for chat_id in data:
            for p in data[chat_id]:
                p['datetime'] = datetime.strptime(p['datetime'], "%Y-%m-%d %H:%M:%S")
        return {int(k): v for k, v in data.items()}
    return {}

# ğŸ“ PlanlarÄ± fayla yaz
def save_plans():
    serializable = {}
    for chat_id, plist in plans.items():
        serializable[str(chat_id)] = []
        for p in plist:
            p_copy = p.copy()
            p_copy['datetime'] = p_copy['datetime'].strftime("%Y-%m-%d %H:%M:%S")
            serializable[str(chat_id)].append(p_copy)
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(serializable, f, ensure_ascii=False, indent=4)

# Planlar yÃ¼klÉ™nir
plans = load_plans()

# /start komandasÄ±
@bot.message_handler(commands=['start'])
def send_welcome(message):
    bot.reply_to(message,
    "ğŸ‘‹ Salam! MÉ™n sÉ™nin planlama botunam.\n\n"
    "ğŸ“Œ ÆmrlÉ™r:\n"
    "/plan - yeni plan É™lavÉ™ et\n"
    "/planlar - planlarÄ±nÄ± gÃ¶stÉ™r\n"
    "/sil - planÄ± sil\n\n"
    "Plan É™lavÉ™ etmÉ™k Ã¼Ã§Ã¼n /plan yaz.")

# /plan komandasÄ±
@bot.message_handler(commands=['plan'])
def plan(message):
    bot.reply_to(message, "âœï¸ Plan yaz:")
    bot.register_next_step_handler(message, add_plan_text)

def add_plan_text(message):
    chat_id = message.chat.id
    plan_text = message.text
    if chat_id not in plans:
        plans[chat_id] = []
    new_plan = {'text': plan_text}
    plans[chat_id].append(new_plan)
    bot.reply_to(message, "ğŸ“… Tarix vÉ™ saat yaz (mÉ™sÉ™lÉ™n: 14.11.2025 18:30)")
    bot.register_next_step_handler(message, add_plan_datetime, new_plan)

def add_plan_datetime(message, plan):
    try:
        plan_datetime = datetime.strptime(message.text, "%d.%m.%Y %H:%M")
        plan['datetime'] = plan_datetime
        bot.reply_to(message, "â° NÉ™ qÉ™dÉ™r vaxt Ã¶ncÉ™ xatÄ±rladÄ±m? (dÉ™qiqÉ™ ilÉ™ yaz)")
        bot.register_next_step_handler(message, add_reminder, plan)
    except ValueError:
        bot.reply_to(message, "âš ï¸ Format yalnÄ±ÅŸdÄ±r. DÃ¼zgÃ¼n format: 14.11.2025 18:30\nYenidÉ™n yaz:")
        bot.register_next_step_handler(message, add_plan_datetime, plan)

def add_reminder(message, plan):
    chat_id = message.chat.id
    try:
        remind_before = int(message.text)
        plan['remind_before'] = remind_before
        save_plans()  # yadda saxla
        bot.reply_to(message,
                     f"âœ… Plan yadda saxlanÄ±ldÄ±!\n\n"
                     f"ğŸ“‹ {plan['text']}\n"
                     f"ğŸ“… {plan['datetime'].strftime('%d.%m.%Y %H:%M')}\n"
                     f"â° {remind_before} dÉ™q Ã¶ncÉ™ xÉ™bÉ™r verilÉ™cÉ™k.")
    except ValueError:
        bot.reply_to(message, "âš ï¸ RÉ™qÉ™mlÉ™ yazmalÄ±san (mÉ™sÉ™lÉ™n: 10)")
        bot.register_next_step_handler(message, add_reminder, plan)

# /planlar komandasÄ±
@bot.message_handler(commands=['planlar'])
def show_plans(message):
    chat_id = message.chat.id
    if chat_id not in plans or len(plans[chat_id]) == 0:
        bot.reply_to(message, "ğŸ“­ HeÃ§ bir plan yoxdur.")
    else:
        text = "ğŸ—“ SÉ™nin planlarÄ±n:\n\n"
        for idx, p in enumerate(plans[chat_id], 1):
            text += (f"{idx}. ğŸ“‹ {p['text']}\n"
                     f"   ğŸ“… {p['datetime'].strftime('%d.%m.%Y %H:%M')}\n"
                     f"   â° {p['remind_before']} dÉ™q Ã¶ncÉ™ xÉ™bÉ™r verilÉ™cÉ™k.\n\n")
        bot.reply_to(message, text)

# /sil komandasÄ±
@bot.message_handler(commands=['sil'])
def delete_plan(message):
    chat_id = message.chat.id
    if chat_id not in plans or len(plans[chat_id]) == 0:
        bot.reply_to(message, "ğŸ—‘ HeÃ§ bir plan yoxdur.")
    else:
        text = "SilmÉ™k istÉ™diyin planÄ±n nÃ¶mrÉ™sini yaz:\n\n"
        for idx, p in enumerate(plans[chat_id], 1):
            text += f"{idx}. {p['text']} ({p['datetime'].strftime('%d.%m.%Y %H:%M')})\n"
        bot.reply_to(message, text)
        bot.register_next_step_handler(message, confirm_delete)

def confirm_delete(message):
    chat_id = message.chat.id
    try:
        idx = int(message.text) - 1
        if chat_id in plans and 0 <= idx < len(plans[chat_id]):
            deleted_plan = plans[chat_id].pop(idx)
            save_plans()
            bot.reply_to(message, f"âœ… Plan silindi:\nğŸ“‹ {deleted_plan['text']}")
        else:
            bot.reply_to(message, "âš ï¸ YanlÄ±ÅŸ nÃ¶mrÉ™.")
    except:
        bot.reply_to(message, "âš ï¸ RÉ™qÉ™mlÉ™ yazmalÄ±san.")

# ğŸ”” XatÄ±rlatma mexanizmi
def reminder_checker():
    while True:
        now = datetime.now()
        for chat_id, user_plans in list(plans.items()):
            for plan in list(user_plans):
                if 'datetime' in plan and 'remind_before' in plan:
                    reminder_time = plan['datetime'] - timedelta(minutes=plan['remind_before'])
                    if reminder_time <= now < reminder_time + timedelta(seconds=30):
                        try:
                            bot.send_message(chat_id,
                                             f"ğŸ”” XatÄ±rlatma vaxtÄ±dÄ±r!\n\n"
                                             f"ğŸ“‹ {plan['text']}\n"
                                             f"ğŸ“… {plan['datetime'].strftime('%d.%m.%Y %H:%M')}")
                            user_plans.remove(plan)
                            save_plans()
                        except Exception as e:
                            print(f"XÉ™ta: {e}")
        time.sleep(20)

# Thread iÅŸÉ™ dÃ¼ÅŸÃ¼r
t = threading.Thread(target=reminder_checker)
t.daemon = True
t.start()

# Botu iÅŸÉ™ sal
bot.polling()
